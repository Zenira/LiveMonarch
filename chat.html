<script src="/socket.io/socket.io.js"></script>
<link rel="stylesheet" href="css/chat.css">
<script>
	var socket = null;
	var port = 3000;
	var onLeaveAlert = true;
	var userName = '';
	var beforeLeaveHandler = function() {
		return 'Would you like to close chat?';
	};
		
	function closeChat() {
		$('#chatModal, #endChatModal').modal('hide');
		$('#chatModal #messages').empty();
		socket.close(); // Close connection
		removeOnLeaveAlert();
	}
	$(document).ready (function() {
		var $form = $('#chatForm');
		var $field = $('#chatMessage');
		var $sendButton = $('#sendMessageBtn');
		var $content = $('#messages');
		var $closeLiveChatBtn = $('#closeLiveChatBtn');
		var $userName = $('#chatUserName');
		
		// Open chat window on click
		//$('#startChatBtn').click (startChat);
		
		$('#chatInitBtn').click (processUserName);
		$userName.keyup(function(e) {
			if(e.keyCode == 13) {
				processUserName();
			}
		});

		$form.submit(function(e){
			sendChatMessage();
			return false;
		});
		
		$sendButton.click (function() {
			sendChatMessage();
		});
		
		function sendChatMessage() {		
			var chatMessage = $.trim($field.val());
			if (chatMessage.length > 0) {
				if (onLeaveAlert) addOnLeaveAlert();
				socket.emit('send', { message: chatMessage });
			}
			$field.val('');
		}
		
		function startChat() {
			if (socket === null || !socket.connected) {
				socket = io.connect('http://localhost:'+port);
				
				// Handle message event
				socket.on('message', function (data) {
					if(data.message) {
						$content.append($('<li class="self">').html(data.message));
					} 
					else if (data.username) {
						console.log("username: " + data.username);
					}
					else {
						console.log("No message: ", data);
					}
				});
				
				
				socket.emit('send', { username: userName });
				

			}
		}
		
		function addOnLeaveAlert() {
			onLeaveAlert = false;
			$closeLiveChatBtn.attr('data-target', '#endChatModal').removeAttr('data-dismiss');
			$(window).bind('beforeunload', beforeLeaveHandler);
		}
		function removeOnLeaveAlert() {
			onLeaveAlert = true;
			$closeLiveChatBtn.attr('data-target', '').attr('data-dismiss', 'modal');
			$(window).unbind('beforeunload', beforeLeaveHandler);
		}
		
		function processUserName() {
			userName = $.trim($userName.val());
			if(userName == "") {
				$('#userNameDiv .chatError').fadeIn();
			} else {
				$('#userNameDiv, #userNameDiv .chatError').hide('fast', function() {
					$('#chatFormDiv').fadeIn();				
				});
				startChat();
			}
		}
	});
</script>
<div id="userNameDiv">
	Your Name:
	<input type="name" id="chatUserName">
	<input type="button" id="chatInitBtn" value="Start Chat">
	<span class="chatError">Please enter your name</span>
</div>
<ul id="messages"></ul>